# This workflow will
# - do a clean installation of node dependencies,
# - cache/restore them,
# - run tests across different versions of node

name: CI - Gitflow

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Gitflow process to trigger"
        type: choice
        default: nothing
        required: true
        options:
          - nothing
          - create
          - merge
          - sync
      confirm_release:
        description: "Confirm release creation"
        type: boolean
        required: false
        default: false
      scope:
        description: "Release scope"
        type: choice
        default: nothing
        required: true
        options:
          - nothing
          - major
          - minor
          - patch

jobs:
  ci-gitflow-nothing:
    if: github.event.inputs.action == 'nothing'
    runs-on: ubuntu-latest
    steps:
      - name: Do Nothing
        run: echo "Do nothing on ${{ github.event.ref }}"
  ci-gitflow-create:
    if: |
      github.event.inputs.action == 'create'
    runs-on: ubuntu-latest
    steps:
      - name: Error - Missing confirm
        if: ${{ !github.event.inputs.confirm_release }}
        run: |
          echo "Release creation not confirmed"
          exit 1
      - name: Error - Missing scope
        if: github.event.inputs.scope == 'nothing'
        run: |
          echo "Release scope not defined"
          exit 1

      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # fetch-depth: to be able to detect diff between release branch and main branch
          fetch-depth: 0

      - name: setup git config
        run: |
          # git config user.name "Release Bot"
          # git config user.email "<>"
          git config user.name $GITHUB_ACTOR
          git config user.email gh-actions-${GITHUB_ACTOR}@github.com

      - name: Create release branch
        id: release
        run: |
          echo "Create release from ${{ github.event.ref }} to ${{ github.event.inputs.release_branch }}"
          cd my-react-app && npm version ${{ github.event.inputs.scope }}
          echo "::set-output name=releaseName::release_$(jq -r .version package.json)"
          git branch ${{ steps.release.outputs.releaseName }}
          git checkout ${{ steps.release.outputs.releaseName }}
          git add package.json
          git commit -m 'Prepare: ${{ steps.release.outputs.releaseName }}'
          git push origin ${{ steps.release.outputs.releaseName }}

      - name: Create pull request
        uses: devops-infra/action-pull-request@v0.4.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          source_branch: ${{ steps.release.outputs.releaseName }}
          target_branch: fake-main
          title: Test - release pull request
          body: "**Automated pull request**"
          draft: false
          get_diff: true
  ci-gitflow-merge:
    if: github.event.inputs.action == 'merge'
    runs-on: ubuntu-latest
    steps:
      - name: Merge release on ...
        run: echo "Merge release on ..."
  ci-gitflow-sync:
    if: github.event.inputs.action == 'sync'
    runs-on: ubuntu-latest
    steps:
      - name: Sync main with ...
        run: echo "Sync main with ..."
